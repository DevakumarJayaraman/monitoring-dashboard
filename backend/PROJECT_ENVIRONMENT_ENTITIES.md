# Database Entities and Repositories - Project and Environment Management

## Overview
Created JPA entities and repositories for the `ops_projects` and `ops_project_environments` tables, and updated `RoleFunctionAccess` to map to `env_id` instead of `env_code`.

## Created Files

### 1. Project Entity
**File:** `backend/src/main/java/com/monitoring/dashboard/model/Project.java`

**Features:**
- Maps to `ops_projects` table
- Primary key: `project_id` (auto-generated)
- Fields: `project_name`, `description`, `version`
- One-to-Many relationship with `ProjectEnvironment`
- Helper methods for bidirectional relationship management
- Optimistic locking with `@Version`

**Key Methods:**
```java
- addEnvironment(ProjectEnvironment) // Add environment to project
- removeEnvironment(ProjectEnvironment) // Remove environment from project
```

### 2. ProjectEnvironment Entity
**File:** `backend/src/main/java/com/monitoring/dashboard/model/ProjectEnvironment.java`

**Features:**
- Maps to `ops_project_environments` table
- Primary key: `env_id` (auto-generated)
- Fields: `env_code`, `region_code`, `profile_code`, `description`, `version`
- Many-to-One relationship with `Project`
- Unique constraint on: `(project_id, env_code, region_code, profile_code)`
- Optimistic locking with `@Version`

**Field Details:**
- `env_code` (required): DEV, UAT, STAGING, PROD
- `region_code` (optional): APAC, EMEA, NAM
- `profile_code` (optional): apacuat, prod-blue, dailyrefresh, etc.

### 3. Updated RoleFunctionAccess Entity
**File:** `backend/src/main/java/com/monitoring/dashboard/model/RoleFunctionAccess.java`

**Changes:**
- ❌ Removed: `envCode` field (String)
- ✅ Added: `environment` field (Many-to-One relationship with `ProjectEnvironment`)
- Maps to `env_id` foreign key instead of storing `env_code` string
- Updated constructor and getters/setters
- Updated `toString()` method

**New Structure:**
```java
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "env_id", nullable = false)
private ProjectEnvironment environment;
```

## Created Repositories

### 1. ProjectRepository
**File:** `backend/src/main/java/com/monitoring/dashboard/repository/ProjectRepository.java`

**Methods:**
- `findByProjectName(String projectName)` - Find project by name
- `existsByProjectName(String projectName)` - Check if project exists

### 2. ProjectEnvironmentRepository
**File:** `backend/src/main/java/com/monitoring/dashboard/repository/ProjectEnvironmentRepository.java`

**Methods:**
- `findByProjectId(Long projectId)` - Get all environments for a project
- `findByEnvCode(String envCode)` - Find by environment code
- `findByRegionCode(String regionCode)` - Find by region
- `findByProfileCode(String profileCode)` - Find by profile
- `findByProjectAndCodes(...)` - Find specific environment by all codes
- `findByProjectIdAndEnvCode(...)` - Find by project and env code

### 3. Updated RoleFunctionAccessRepository
**File:** `backend/src/main/java/com/monitoring/dashboard/repository/RoleFunctionAccessRepository.java`

**Changes:**
- ❌ Removed: `findByRoleNameAndEnvCode(String, String)`
- ✅ Added: `findByRoleNameAndEnvId(String, Long)`
- ✅ Added: `findByRoleNameAndFunctionCodeAndEnvId(...)`
- ✅ Added: `findByRoleName(String)`
- ✅ Added: `findByFunctionCode(String)`
- ✅ Added: `findByEnvId(Long)`

## Database Schema Mapping

### ops_projects Table
```sql
CREATE TABLE ops_projects (
    project_id    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    project_name  VARCHAR2(255) NOT NULL,
    description   VARCHAR2(1000),
    version       NUMBER(10) DEFAULT 0 NOT NULL
);
```
✅ Mapped to `Project` entity

### ops_project_environments Table
```sql
CREATE TABLE ops_project_environments (
    env_id         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    project_id     NUMBER NOT NULL REFERENCES ops_projects(project_id),
    env_code       VARCHAR2(50) NOT NULL,
    region_code    VARCHAR2(50),
    profile_code   VARCHAR2(100),
    description    VARCHAR2(255),
    version        NUMBER(10) DEFAULT 0 NOT NULL,
    CONSTRAINT uk_project_env_region_profile UNIQUE (project_id, env_code, region_code, profile_code)
);
```
✅ Mapped to `ProjectEnvironment` entity

### Updated ops_role_function_access
- Now references `env_id` (foreign key to `ops_project_environments`)
- Replaces direct `env_code` string storage with proper relationship

## Benefits

1. **Proper Relationships:** Projects, environments, and access controls are now properly linked
2. **Data Integrity:** Foreign key constraints ensure referential integrity
3. **Flexibility:** Supports multiple environments per project with region and profile variations
4. **Reusability:** Environment definitions are centralized and can be reused
5. **Query Efficiency:** JPA relationships enable efficient queries with joins
6. **Type Safety:** Using entity references instead of string codes

## Usage Examples

### Create Project with Environment
```java
Project project = new Project("Monitoring Dashboard", "Main monitoring application");

ProjectEnvironment env = new ProjectEnvironment("PROD", "APAC", "apacprod", "APAC Production");
project.addEnvironment(env);

projectRepository.save(project);
```

### Find Access by Environment
```java
List<RoleFunctionAccess> accessList = 
    roleFunctionAccessRepository.findByRoleNameAndEnvId("Admin", envId);
```

### Query Environments
```java
List<ProjectEnvironment> prodEnvs = 
    projectEnvironmentRepository.findByEnvCode("PROD");
```

## Migration Notes

If you have existing data with `env_code` in `ops_role_function_access`, you'll need to:
1. Create entries in `ops_project_environments` for all unique environment combinations
2. Update `ops_role_function_access` to reference `env_id` instead of `env_code`
3. Drop the old `env_code` column once migration is complete

## Files Created/Modified Summary

**Created:**
- ✅ `Project.java` - Project entity
- ✅ `ProjectEnvironment.java` - Environment entity
- ✅ `ProjectRepository.java` - Project repository
- ✅ `ProjectEnvironmentRepository.java` - Environment repository

**Modified:**
- ✅ `RoleFunctionAccess.java` - Updated to use env_id relationship
- ✅ `RoleFunctionAccessRepository.java` - Updated query methods for env_id
